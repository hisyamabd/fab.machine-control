<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fabrication Machine Control — Live Camera Demo</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root {
      --primary: #0d6efd;
      --danger: #dc3545;
      --success: #198754;
      --muted: #6c757d;
    }

    body { background:#f6f8fb; font-family:Inter, system-ui, Arial, sans-serif; }
    .page { max-width:1100px; margin:28px auto; }

    /* card */
    .panel { background:#fff; border-radius:10px; padding:18px; box-shadow:0 6px 18px rgba(10,20,40,0.06); }

    /* status boxes */
    .status-box { padding:14px;border-radius:8px;margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; }
    .op-ok { background: #f0fff4; border:1px solid #36b37e; }
    .op-bad { background: #fff6f6; border:1px solid #e05a5a; }

    /* video */
    #videoWrap { 
      background:#000; 
      border-radius:8px; 
      overflow:hidden; 
      min-height:320px; 
      display:flex; 
      align-items:center; 
      justify-content:center;
      position: relative;
    }
    
    #video { 
      width:100%; 
      height:auto; 
      display:block; 
      border-radius:8px;
      transform-origin: center;
    }
    
    #videoFallback {
      color: #fff;
      text-align: center;
      padding: 20px;
    }

    /* Camera status indicator */
    .camera-status {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
      animation: blink 1s infinite;
    }

    .status-live { background: #28a745; }
    .status-error { background: #dc3545; }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.5; }
    }

    /* live button styles */
    .btn-ripple { position:relative; overflow:hidden; }
    .btn-ripple .ripple {
      position: absolute;
      border-radius: 50%;
      transform: scale(0);
      background: rgba(255,255,255,0.6);
      animation: ripple 600ms linear;
      pointer-events:none;
    }
    @keyframes ripple {
      to { transform: scale(4); opacity:0; }
    }

    /* spinner inside button */
    .btn .spinner-border { width:1rem; height:1rem; border-width:0.12em; margin-right:6px; vertical-align:middle; }

    /* machine running pulse */
    .machine-on { box-shadow: 0 0 0 0 rgba(25, 135, 84, .4); animation: pulse 2s infinite; }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(25,135,84,0.6); }
      70% { box-shadow: 0 0 0 10px rgba(25,135,84,0); }
      100% { box-shadow: 0 0 0 0 rgba(25,135,84,0); }
    }

    /* hold-to-confirm emergency */
    .hold-circle {
      width:46px; height:46px; border-radius:50%; display:inline-flex;align-items:center;justify-content:center;
      background:linear-gradient(180deg,#fff 0,#ffecec 100%); border:1px solid rgba(0,0,0,0.06);
      position:relative; overflow:hidden;
    }
    .hold-progress {
      position:absolute; left:0; top:0; height:100%; width:0%; background:rgba(220,53,69,0.12); transition:width 0.05s linear;
    }

    /* log area */
    .log-area { height:150px; overflow:auto; background:#0b1220; color:#dbeafe; padding:10px; border-radius:6px; font-family:monospace; font-size:13px; }

    /* Gallery thumbnails */
    .gallery-thumb {
      width: 80px;
      height: 60px;
      object-fit: cover;
      border-radius: 4px;
      border: 2px solid #ddd;
      cursor: pointer;
      transition: all 0.2s;
    }

    .gallery-thumb:hover {
      border-color: var(--primary);
      transform: scale(1.05);
    }

    /* small helpers */
    .muted { color:var(--muted); }
  </style>
</head>
<body>

  <div class="page">
    <div class="panel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="m-0">Fabrication Machine Control — Live Camera</h4>
        <small class="text-muted">Akses kamera laptop untuk monitoring</small>
      </div>

      <div class="row gy-3">
        <!-- Left: Video + Camera controls -->
        <div class="col-lg-7">
          <div class="mb-3 panel">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>Live Camera Feed</strong>
              <div>
                <button id="btnStartCamera" class="btn btn-sm btn-success me-2 btn-ripple">
                  <i class="fas fa-video"></i> Start Camera
                </button>
                <button id="btnStopCamera" class="btn btn-sm btn-danger me-2 btn-ripple">
                  <i class="fas fa-video-slash"></i> Stop Camera
                </button>
                <button id="btnSnap" class="btn btn-sm btn-primary btn-ripple">
                  <i class="fas fa-camera"></i> Snapshot
                </button>
              </div>
            </div>

            <div id="videoWrap">
              <video id="video" autoplay playsinline muted style="display:none;"></video>
              <div id="videoFallback" class="text-center">
                <i class="fas fa-video fa-3x mb-3 text-muted"></i>
                <h5>Camera Not Active</h5>
                <p class="text-muted">Click "Start Camera" to begin video feed</p>
              </div>
              <div id="cameraStatus" class="camera-status" style="display:none;">
                <div class="status-dot status-live"></div>
                <span>LIVE</span>
              </div>
            </div>

            <!-- Camera Controls -->
            <div class="row mt-3">
              <div class="col-md-6">
                <label class="form-label small">Zoom: <span id="zoomValue">100%</span></label>
                <input id="zoom" type="range" min="100" max="300" class="form-range" value="100">
              </div>
              <div class="col-md-6">
                <label class="form-label small">Resolution</label>
                <select id="resolution" class="form-select form-select-sm">
                  <option value="640x480">640 x 480</option>
                  <option value="1280x720" selected>1280 x 720 (HD)</option>
                  <option value="1920x1080">1920 x 1080 (Full HD)</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Gallery -->
          <div class="mb-3 panel">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <strong>Captured Images</strong>
                <small class="muted d-block">Click thumbnail to view full size</small>
              </div>
              <button id="btnClearGallery" class="btn btn-sm btn-outline-secondary btn-ripple">
                <i class="fas fa-trash"></i> Clear
              </button>
            </div>
            <div id="gallery" class="d-flex gap-2 mt-2 flex-wrap" style="min-height: 80px; align-items: center;">
              <small class="text-muted">No images captured yet</small>
            </div>
          </div>
        </div>

        <!-- Right: Status + Controls + Log -->
        <div class="col-lg-5">
          <div id="opStatus" class="status-box op-ok mb-2">
            <div>
              <div class="small muted">Status Operator</div>
              <div><strong id="opText">TIDAK TERDETEKSI</strong></div>
            </div>
            <div>
              <button id="btnToggleOp" class="btn btn-sm btn-outline-danger btn-ripple">Toggle Operator</button>
            </div>
          </div>

          <div id="machineBox" class="status-box" style="background:#fff7ed;border:1px solid #ffd89b;">
            <div>
              <div class="small muted">Status Mesin</div>
              <div><strong id="machineText">MATI</strong></div>
              <div class="muted small">Runtime: <span id="runtime">0 s</span></div>
            </div>
            <div class="d-flex flex-column align-items-end">
              <div class="mb-2">
                <button id="btnStart" class="btn btn-success btn-ripple">Nyalakan</button>
                <button id="btnStop" class="btn btn-danger btn-ripple">Matikan</button>
              </div>

              <div class="d-flex gap-2 align-items-center">
                <div class="hold-circle" id="estopWrap" title="Tekan dan tahan 1s untuk Emergency Stop">
                  <div class="hold-progress" id="estopProgress"></div>
                  <button id="btnEStop" class="btn btn-link p-0" style="font-weight:bold;color:var(--danger)">E</button>
                </div>
                <small class="muted">Emergency Stop (hold)</small>
              </div>
            </div>
          </div>

          <!-- Actions & Presets section DIHAPUS -->

          <div class="panel">
            <strong>Activity Log</strong>
            <div id="log" class="log-area mt-2"></div>
            <div class="mt-2 d-flex gap-2">
              <button id="btnClear" class="btn btn-sm btn-outline-secondary btn-ripple">Clear</button>
              <button id="btnExport" class="btn btn-sm btn-outline-success btn-ripple">Export</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    // ---------- helper: ripple effect ----------
    document.addEventListener('click', function(e){
      const btn = e.target.closest('.btn-ripple');
      if (!btn) return;
      const rect = btn.getBoundingClientRect();
      const ripple = document.createElement('span');
      ripple.className = 'ripple';
      const size = Math.max(rect.width, rect.height);
      ripple.style.width = ripple.style.height = size + 'px';
      ripple.style.left = (e.clientX - rect.left - size/2) + 'px';
      ripple.style.top = (e.clientY - rect.top - size/2) + 'px';
      btn.appendChild(ripple);
      setTimeout(()=> ripple.remove(), 650);
    });

    // ---------- state ----------
    let operatorDetected = false;
    let machineOn = false;
    let runtimeStart = null;
    let runtimeTimer = null;
    let currentStream = null;

    const opStatusEl = document.getElementById('opStatus');
    const opText = document.getElementById('opText');
    const machineBox = document.getElementById('machineBox');
    const machineText = document.getElementById('machineText');
    const runtimeEl = document.getElementById('runtime');
    const logEl = document.getElementById('log');
    const video = document.getElementById('video');
    const videoFallback = document.getElementById('videoFallback');
    const cameraStatus = document.getElementById('cameraStatus');
    const gallery = document.getElementById('gallery');

    // ---------- logging ----------
    function log(msg){
      const t = new Date().toLocaleTimeString();
      logEl.textContent = `[${t}] ${msg}
` + logEl.textContent;
    }

    // ---------- Camera Functions ----------
    async function startCamera() {
      try {
        // Stop existing stream if any
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }

        // Get resolution from dropdown
        const resolution = document.getElementById('resolution').value;
        const [width, height] = resolution.split('x').map(Number);

        // Request camera access with constraints
        const constraints = {
          video: {
            width: { ideal: width },
            height: { ideal: height },
            facingMode: 'user' // Use front camera on mobile
          },
          audio: false
        };

        log('Requesting camera access...');
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        
        // Assign stream to video element
        video.srcObject = currentStream;
        video.style.display = 'block';
        videoFallback.style.display = 'none';
        cameraStatus.style.display = 'block';
        
        log(`Camera started successfully (${width}x${height})`);
        
        // Update button states
        document.getElementById('btnStartCamera').disabled = true;
        document.getElementById('btnStopCamera').disabled = false;
        document.getElementById('btnSnap').disabled = false;

      } catch (error) {
        console.error('Camera access error:', error);
        let errorMsg = 'Failed to access camera: ';
        
        switch(error.name) {
          case 'NotAllowedError':
            errorMsg += 'Permission denied. Please allow camera access.';
            break;
          case 'NotFoundError':
            errorMsg += 'No camera found on this device.';
            break;
          case 'NotReadableError':
            errorMsg += 'Camera is being used by another application.';
            break;
          default:
            errorMsg += error.message;
        }
        
        log(errorMsg);
        alert(errorMsg);
        
        // Show fallback
        video.style.display = 'none';
        videoFallback.style.display = 'block';
        videoFallback.innerHTML = `
          <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
          <h5>Camera Error</h5>
          <p class="text-muted">${errorMsg}</p>
          <button class="btn btn-primary btn-sm" onclick="startCamera()">Try Again</button>
        `;
        cameraStatus.style.display = 'none';
      }
    }

    function stopCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
      }
      
      video.srcObject = null;
      video.style.display = 'none';
      videoFallback.style.display = 'block';
      videoFallback.innerHTML = `
        <i class="fas fa-video fa-3x mb-3 text-muted"></i>
        <h5>Camera Stopped</h5>
        <p class="text-muted">Click "Start Camera" to begin video feed</p>
      `;
      cameraStatus.style.display = 'none';
      
      // Update button states
      document.getElementById('btnStartCamera').disabled = false;
      document.getElementById('btnStopCamera').disabled = true;
      document.getElementById('btnSnap').disabled = true;
      
      log('Camera stopped');
    }

    function takeSnapshot() {
      if (!currentStream || !video.videoWidth) {
        alert('Camera not active or not ready');
        return;
      }

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Set canvas size to video dimensions
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      
      // Draw current video frame to canvas
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // Convert to data URL
      const dataURL = canvas.toDataURL('image/jpeg', 0.9);
      
      // Create thumbnail for gallery
      const img = document.createElement('img');
      img.src = dataURL;
      img.className = 'gallery-thumb';
      img.title = `Captured at ${new Date().toLocaleTimeString()}`;
      
      // Add click handler for full view
      img.addEventListener('click', () => {
        const newWindow = window.open();
        newWindow.document.write(`<img src="${dataURL}" style="max-width:100%;height:auto;">`);
      });
      
      // Clear "no images" message if this is first image
      if (gallery.querySelector('small')) {
        gallery.innerHTML = '';
      }
      
      // Add to gallery (newest first)
      gallery.insertBefore(img, gallery.firstChild);
      
      // Limit gallery to 10 images
      while (gallery.children.length > 10) {
        gallery.removeChild(gallery.lastChild);
      }
      
      log('Snapshot captured');
    }

    // ---------- UI updates ----------
    function updateOperatorUI(){
      if (operatorDetected){
        opStatusEl.classList.remove('op-ok');
        opStatusEl.classList.add('op-bad');
        opText.textContent = 'TERDETEKSI';
        log('Operator terdeteksi — remote dinonaktifkan');
      } else {
        opStatusEl.classList.remove('op-bad');
        opStatusEl.classList.add('op-ok');
        opText.textContent = 'TIDAK TERDETEKSI';
        log('Operator tidak terdeteksi — remote aktif');
      }
      // disable start if operator present
      document.getElementById('btnStart').disabled = operatorDetected;
    }

    function updateMachineUI(){
      if (machineOn){
        machineText.textContent = 'NYALA';
        machineBox.classList.add('machine-on');
        if (!runtimeStart) runtimeStart = Date.now();
        if (!runtimeTimer) runtimeTimer = setInterval(()=> {
          runtimeEl.textContent = Math.floor((Date.now()-runtimeStart)/1000) + ' s';
        }, 500);
      } else {
        machineText.textContent = 'MATI';
        machineBox.classList.remove('machine-on');
        runtimeStart = null;
        if (runtimeTimer) { clearInterval(runtimeTimer); runtimeTimer = null; runtimeEl.textContent = '0 s'; }
      }
    }

    // simulate network request with loader in button
    function simulateAction(btn, callback, opts={delay:1000}){
      const original = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing';
      setTimeout(()=> {
        btn.innerHTML = original;
        btn.disabled = false;
        callback && callback();
      }, opts.delay);
    }

    // ---------- Event Handlers ----------
    
    // Camera controls
    document.getElementById('btnStartCamera').addEventListener('click', startCamera);
    document.getElementById('btnStopCamera').addEventListener('click', stopCamera);
    document.getElementById('btnSnap').addEventListener('click', takeSnapshot);
    document.getElementById('btnClearGallery').addEventListener('click', () => {
      gallery.innerHTML = '<small class="text-muted">No images captured yet</small>';
      log('Gallery cleared');
    });

    // Zoom control
    document.getElementById('zoom').addEventListener('input', function(){
      const scale = this.value / 100;
      video.style.transform = `scale(${scale})`;
      document.getElementById('zoomValue').textContent = this.value + '%';
    });

    // Resolution change
    document.getElementById('resolution').addEventListener('change', function(){
      if (currentStream) {
        log('Resolution changed - restart camera for effect');
      }
    });

    // Machine controls
    document.getElementById('btnToggleOp').addEventListener('click', () => {
      operatorDetected = !operatorDetected;
      updateOperatorUI();
    });

    document.getElementById('btnStart').addEventListener('click', function(){
      const btn = this;
      if (operatorDetected) { 
        alert('Gagal: Operator terdeteksi!'); 
        log('Percobaan start diblokir (operator present)'); 
        return; 
      }
      simulateAction(btn, () => {
        machineOn = true; 
        updateMachineUI(); 
        log('Mesin dinyalakan (via Start)');
      }, {delay:1200});
    });

    document.getElementById('btnStop').addEventListener('click', function(){
      const btn = this;
      simulateAction(btn, () => {
        machineOn = false; 
        updateMachineUI(); 
        log('Mesin dimatikan (via Stop)');
      }, {delay:800});
    });

    // Emergency stop: hold behavior
    (function(){
      const btn = document.getElementById('btnEStop');
      const prog = document.getElementById('estopProgress');
      let holdTimer = null, startTs = 0;
      const HOLD_MS = 1500;

      function triggerEStop(){
        machineOn = false; 
        updateMachineUI(); 
        log('EMERGENCY STOP triggered!'); 
        alert('EMERGENCY STOP!');
        prog.style.width = '0%';
      }

      btn.addEventListener('mousedown', (e) => {
        startTs = Date.now();
        prog.style.width = '0%';
        holdTimer = setInterval(()=> {
          const elapsed = Date.now() - startTs;
          const pct = Math.min(100, (elapsed / HOLD_MS)*100);
          prog.style.width = pct + '%';
          if (elapsed >= HOLD_MS) {
            clearInterval(holdTimer); holdTimer = null; triggerEStop();
          }
        }, 30);
      });
      
      document.addEventListener('mouseup', ()=> {
        if (holdTimer) { 
          clearInterval(holdTimer); 
          holdTimer = null; 
          prog.style.width = '0%'; 
          log('E-Stop cancelled'); 
        }
      });
      
      btn.addEventListener('touchstart', (e)=> { 
        e.preventDefault(); 
        btn.dispatchEvent(new MouseEvent('mousedown')); 
      });
      
      document.addEventListener('touchend', ()=> 
        document.dispatchEvent(new Event('mouseup'))
      );
    })();

    // Clear / Export logs
    document.getElementById('btnClear').addEventListener('click', ()=> { 
      logEl.textContent=''; 
      log('Log cleared');
    });
    
    document.getElementById('btnExport').addEventListener('click', ()=> {
      const blob = new Blob([logEl.textContent], {type:'text/plain'});
      const a = document.createElement('a'); 
      a.href = URL.createObjectURL(blob); 
      a.download = 'activity_log.txt'; 
      a.click();
      log('Log exported');
    });

    // Auto-simulation: toggle operator randomly every 12-20s (demo)
    setInterval(()=> {
      if (Math.random() < 0.25) { 
        operatorDetected = !operatorDetected; 
        updateOperatorUI(); 
      }
    }, 10000 + Math.random()*10000);

    // Check camera availability on load
    async function checkCameraAvailability() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        
        if (videoDevices.length === 0) {
          log('No camera devices found');
          videoFallback.innerHTML = `
            <i class="fas fa-video-slash fa-3x mb-3 text-muted"></i>
            <h5>No Camera Available</h5>
            <p class="text-muted">No camera devices detected on this system</p>
          `;
        } else {
          log(`${videoDevices.length} camera device(s) found`);
        }
        
      } catch (error) {
        log('Error checking camera availability: ' + error.message);
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Set initial button states
      document.getElementById('btnStopCamera').disabled = true;
      document.getElementById('btnSnap').disabled = true;
      
      // Initial UI
      updateOperatorUI();
      updateMachineUI();
      
      // Check camera availability
      checkCameraAvailability();
      
      log('Demo siap — klik "Start Camera" untuk mengakses webcam laptop');
    });

    // Handle page unload - cleanup camera
    window.addEventListener('beforeunload', function() {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }
    });

  </script>

</body>
</html>
